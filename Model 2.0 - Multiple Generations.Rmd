---
title: "Model 2.0 - Multi-generational Multilingualism"
author: "Amy Anderson"
date: "2024-05-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r, message=FALSE, echo=FALSE, include=FALSE}
### Load libraries
library(tidyverse)
library(cowplot)



### Load bespoke functions

## create character vector of all file names inside the 'Functions' folder
# specify function to generate agent IDs first -- this function is called in the 'Example Use' section of some other function files, and that will cause issues if it isn't loaded into the workspace before the files that use it.
first_function <- "./Functions//Generate Agent IDs.R"
generate_starting_pop <- "./Functions//Generate Time0 Agents.R"
function_files <- list.files(path="./Functions/", full.names=TRUE) # all file names in Function folder
function_files <- function_files[which(function_files != "./Functions//Generate Agent IDs.R" & function_files != "./Functions//Generate Time0 Agents.R")] # remove the agent ID function
function_files <- c(first_function, function_files, generate_starting_pop) # put it back in as the first item in the list of names. 

# apply the source() command to all Function file names them to pull the functions into the working environment. 
sapply(function_files, FUN=source) 

```


 - Designate languages in play. 
```{r}
languages <- choose_local_languages(3)
```


 - Generate a starting set of agents, and their age structure:
```{r}
# This starting population is 1,000 agents with a 1:1 sex ratio and a uniform distribution of ages between 0 and 80.
agent_census <- make_uniform_population(n = 1000, max_age = 80)

```


 - Assign initial languages proficiencies for agents at Time 0:
```{r}
# This function assumes an equal number of monolingual speakers for each local language.
agent_census <- assign_starting_proficiency(agent_census)
```


 - Pair up males/females for reproductive partnerships: 
```{r}

agent_census <- select_marriage_partners(agent_census, calculate_dyad_score = calc_dyad_age_similarity)


```


 - Generate new births in existing partnerships. Assign traits to newborn agents. 
```{r}

new_mothers <- sow(tfr = 2, agent_census)

agent_census <- birth_new_agents(agent_census, new_mothers)

```


 - Pick conversation partners for the year.
```{r}

# This function assigns partners by sampling at random, with replacement. Each agent will experience a minimum of 10 conversations. 
interactions <- select_conversation_partners(agent_census)
```


 - Now that the interaction matrix for this round is generated, Count up the number of interactions each agent has had. 
```{r}

conversants <- sapply(seq(agent_census$agent_id), record_conversations, interactions)
```



 - Record which language each agent chooses to speak in each conversation:
```{r}

# Calculate a list of conversation languages heard by each agent
languages_of_conversation <- lapply(conversants, select_language_of_conversation)

```


 - Record each agent's relative frequency of exposure to each language in this year of conversations:
```{r}

relative_exposures <- lapply(languages_of_conversation, FUN = calculate_language_exposures)
agent_language_exposures <- as.data.frame(matrix(unlist(relative_exposures), ncol = 3))
names(agent_language_exposures) <- languages
                                  
```


### *Learn Languages!*
 - Increase each agent's language proficiency in the population languages as a function of:
   1. their exposure to the language
   2. their age at time of exposure t.
```{r}

agent_census <- learn_languages(agent_language_exposures, pop = agent_census)

```



 - Calculate annual deaths.
```{r}
# Mortality Regime parameters for Siler model. Based on parameter values for Tsimane horticulturalists from Gurven and Kaplan 2007.
Tsimane <- data.frame(a1= 0.221,
                      b1= 1.193,
                      a2= 0.009,
                      a3= 0.000023,
                      b3= 0.119)
agent_census <- reap(agent_census, mortality_regime = Tsimane)

```


 - People who survived this round turn 1 year older
```{r}

agent_census$age[is.na(agent_census$death_recorded)] <- agent_census$age[is.na(agent_census$death_recorded)] + 1
```



Repeat all of this living for the next value of time t.
